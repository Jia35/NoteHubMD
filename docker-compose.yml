services:
  db:
    image: postgres:17.6
    container_name: postgres
    restart: always
    environment:
      POSTGRES_USER: "notehubmd"
      POSTGRES_PASSWORD: "notehubmd_password"
      POSTGRES_DB: "notehubmd"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  app:
    image: jia35/notehubmd:0.1.0
    container_name: notehubmd
    restart: always
    ports:
      - "3000:3000"
    environment:
      DB_DIALECT: "postgres"
      DB_HOST: "postgres"
      DB_PORT: 5432
      DB_USERNAME: "notehubmd"
      DB_PASSWORD: "notehubmd_password"
      DB_NAME: "notehubmd"
      SESSION_SECRET: "change-this-in-production"
      # 流程圖編輯器網址 (預設使用公開服務: https://embed.diagrams.net)
      # 如需使用自架 Draw.io，請設定為: http://drawio:8080 (Docker 內部溝通需注意瀏覽器是否可訪問，通常建議設為外部可訪問的網址)
      # 或是透過 Nginx 反向代理 /drawio/
      # DRAWIO_URL: "https://embed.diagrams.net"
      # Proxy 設定（選用）
      # HTTP_PROXY: "http://proxy.example.com:8080"
      # HTTPS_PROXY: "http://proxy.example.com:8080"
      # NO_PROXY: "localhost,127.0.0.1,postgres"
    depends_on:
      - db
    volumes:
      - uploads_data:/app/_uploads
      # - ./backend/.env:/app/backend/.env:ro

  drawio:
    image: jgraph/drawio:latest
    container_name: drawio
    restart: always
    ports:
      - "8080:8080"
    environment:
      # Disable external resources for offline/internal use
      DRAWIO_SELF_CONTAINED: 1

volumes:
  postgres_data:
  uploads_data:
